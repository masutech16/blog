---
title: "CORSについて理解しよう"
date: 2018-11-30T12:20:31+09:00
draft: false
---

# CORS について理解する

## CORS とは

　CORS とは Cross-Origin Resource Sharing の略で、超簡単に言えば、あるオリジンのアプリケーションに対して、他のオリジンにある特定のデータを取ることを許可する仕組みのことです。

　このとき、許可を出すのはリソースを持っているオリジンです。こいつがあるオリジンに対して「お前このリソースにアクセスしていいよ」っていうと、許可を受けたオリジンはそのリソースを得ることができます。

　基本の仕組みはこんな感じです。



## そもそも Origin って何？

　Origin はプロトコル + ドメイン + ポート番号で構成される三つ組(タプル)です。

　一般的な web アプリでは基本 HTTP で 80 番でつなぐようになっているはずなので、実質的にはドメインが一致していればたいていの場合 Origin も一致していることになります。



## なぜ CORS のような仕組みがあるのか

　CORS という仕組みがあるということは、許可がなければ別のオリジンのリソースを取得することができないということを意味します。なんでこんな仕組みになっているのでしょうか？

　もし逆に、基本的には別のオリジンのリソースにアクセスすることが可能であったとしましょう。その場合、任意のオリジンのリソースは常に悪意のある攻撃者の脅威に晒されることになります。

　これが危険な状態であるということはよくわかります。そのため、各オリジンは外部のオリジンからのアクセスを基本的に受け付けないというポリシーが生まれました。これは同一オリジンポリシーと呼ばれるものです。

　つまり、 CORS は同一オリジンポリシーの中で、安全に外部のオリジンと通信を行うために必要な仕組みである、ということです。



## 具体的な方法について

　ここからは、具体的に別のオリジンに許可を出す方法についてみていきます。CORS にはいくつか種類があります。具体的には単純リクエストやプリフライトリクエストなどです。

　今言った用語は MDN の CORS のページに対応しています。どのリクエストがどの方式に当てはまるのか等の詳細は MDN を確認してください。



### 単純リクエスト (GET等)

　一番単純な例です。

　具体例をまず見ていきましょう。リソースを持つオリジンを A 、リクエストを行うオリジンを B とします。B は A のデータを利用したいので、まずは A に対して HTTP Request を投げます。

　この際、 A はアクセスしてきたオリジンによってどう対応するのかを決めたいので、 B のリクエストには自分のオリジンが含まれていなければなりません。

　A はこのリクエストのレスポンスに対して、許可を出しているドメイン情報を載せたレスポンスを返します。この中に B のオリジンが含まれていればめでたくデータを取得できるというわけですね。

　実際の通信では、 リクエストの `Origin` ヘッダーに B のオリジン情報が乗り、 レスポンスの `Access-Control-Allow-Origin` ヘッダーに許可するオリジンの情報が乗ります。



### プリフライトリクエスト(PUT , DELETE 等)

　PUT や DELETE はリソースを持つオリジンのデータを破壊する恐れがあるメソッドです。GETは許したいけどこういうのはちょっと困るな、という場面は少なくないでしょう。そこで、 CORS では各オリジンが利用できるメソッドに対して制限をかける仕組みが存在します。

　実際の大まかな流れを確認しましょう。

　上記のようなメソッド( PUT , DELETE 等)を利用するとき、クライアント側は自分が今から飛ばすリクエストが許可されているかを確認しなければなりません。そこで、これを確認するためのリクエストを同一の URL にまず飛ばします。このリクエストがプリフライトリクエストと呼ばれるものです。

　プリフライトのレスポンスの結果、利用するメソッドが許可されていた場合は、本来のリクエストをそのまま送ります。ダメだったら本来のリクエストは送信されないので、サーバーのデータが変更されるということは起こりえません。

　全体の流れはこんな感じです。次に、実際の通信では何をしているのかを確認しましょう。

　プリフライトリクエストのヘッダーには `Access-Control-Request-Method`, `Access-Control-Request-Headers` というものが載っています。これらには実際のリクエストで用いるメソッドやヘッダーを記載します。

　これに対するレスポンスヘッダーには `Access-Control-Allow-Origin` に加えて `Access-Control-Allow-Method` 、 `Access-Control-Allow-Headers` というものが載っています。クライアントはこれらを総合的に見て、実際のリクエストが許可されているかどうかを調べ、可能であれば実際のリクエストを送ります。こちらにはプリフライトリクエストのヘッダーに載せた情報は載せません。

　ヘッダーを載せる意図としては `CSRF` 対策などな気がしていますが、しっかりとは理解できていません。どなたか詳しい方がいらっしゃればご教授お願いします。



## おまけ： Cookie を利用するとき

　CORS について調べると、 Cookie を利用するときは `Access-Control-Allow-Credentials` を true にしましょう、という文言を見かけると思います。

　このヘッダーがついていない場合、ブラウザ側がレスポンス内容を捨てるので表示がされないようです。これを阻止するアドオンなども存在しているようですので、開発の際はそっちを入れてみてもいいかもしれません。



## 参考文献

+ [オリジン間リソース共有 (CORS) - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS)
+ [Access-Control-Allow-Credentials - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)